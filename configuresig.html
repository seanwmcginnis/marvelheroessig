<!DOCTYPE HTML>
<html>
    <!--
         *  Interactive Marvel Heroes Forum Signature Generator
         *
          Copyright 2013 Sean McGinnis
          http://www.seanwmcginnis.com/marvelheroes/configuresig.php
    
          Permission is hereby granted, free of charge, to any person obtaining
          a copy of this software and associated documentation files (the
          "Software"), to deal in the Software without restriction, including
          without limitation the rights to use, copy, modify, merge, publish,
          distribute, sublicense, and/or sell copies of the Software, and to
          permit persons to whom the Software is furnished to do so, subject to
          the following conditions:
    
          The above copyright notice and this permission notice shall be
          included in all copies or substantial portions of the Software.
    
          THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
          EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
          MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
          NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
          LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
          OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
          WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
         */
    
        /*
         * configuresig.php: This is the module that configures the image.  This is a site that uses jQuery to do most of the work.
         */
    -->
    <head>
        <title>Configure Marvel Heroes Custom Sig</title>
        <link rel="stylesheet" href="default.css?version=2.13.1" type="text/css">
        <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
        <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
        <script src="jquery.ui.touch-punch.min.js"></script>
        <script src="marvelheroes_classes.js?version=2.13.1"></script>
        <script src="spin.js" type="text/javascript"></script>
        <script type="text/javascript" src="jscolor/jscolor.js"></script>
        <script type="text/javascript" src="jquery.cookie/src/jquery.cookie.js"></script>
        <script>
            // V1 was all PHP.  This one is mostly jQuery.  Good stuff -- a lot less load on the server, and a better end-user experience.
            // The general model is: the server puts character info in hidden fields.  This code loads it and does all of the rendering and whatnot.

            // The characters array stores info about the characters
            var characters = new Array();
            function loadCharacters()
            {
                console.log("Beginning load characters.");
                doSpin();
                var params = "";
                var url = "loadcharacters.php";
                console.log("URL: " + url + "?" + params);
                $.ajax({
                    dataType: "json",
                    url: url,
                    data: params,
                    timeout: 10000,
                    success: function (data) {
                        finishLoadCharacters(data);
                    },
                    error: function (xhr, status, error)
                    {
                        var requestResponse = {
                            httpStatus: xhr.status,
                            error: xhr.statusText,
                            text: xhr.responseText,
                            passedstatus: status,
                            location: "AJAX"
                        };
                        handleError(requestResponse);
                    }
                });
            }

            // The flair array stores info about the flair icons
            var flair = new Array();
            function loadFlair()
            {
                console.log("Beginning load flair.");
                doSpin();
                var params = "";
                var url = "loadflair.php";
                console.log("URL: " + url + "?" + params);
                $.ajax({
                    dataType: "json",
                    url: url,
                    data: params,
                    timeout: 10000,
                    success: function (data) {
                        finishLoadFlair(data);
                    },
                    error: function (xhr, status, error)
                    {
                        var requestResponse = {
                            httpStatus: xhr.status,
                            error: xhr.statusText,
                            text: xhr.responseText,
                            passedstatus: status,
                            location: "AJAX"
                        };
                        handleError(requestResponse);
                    }
                });
            }

            function loadFonts()
            {
                console.log("Beginning load fonts.");
                doSpin();
                var params = "";
                var url = "loadfonts.php";
                console.log("URL: " + url + "?" + params);
                $.ajax({
                    dataType: "json",
                    url: url,
                    data: params,
                    timeout: 10000,
                    success: function (data) {
                        finishLoadFonts(data);
                    },
                    error: function (xhr, status, error)
                    {
                        var requestResponse = {
                            httpStatus: xhr.status,
                            error: xhr.statusText,
                            text: xhr.responseText,
                            passedstatus: status,
                            location: "AJAX"
                        };
                        handleError(requestResponse);
                    }
                });
            }
            // saveSig had some validation in it at some point, but it posts back to the server
            // NOTE: the "action" field is used as a dirty flag.  It gets reset when the grids change.
            function saveSig() {
                doSpin();
                var params = "";
                var font = $("#font").val();
                var view_mode = $("#view_mode").val();
                var position_grid = $("#position_grid").val();
                var costume_grid = $("#costume_grid").val();
                var flair_grid = $("#flair_grid").val();
                var level_grid = $("#level_grid").val();
                var border_type = $("#border_type").val();
                var border_color = $("#border_color").val();
                var half_grids = $("#half_grids").val();
                var links = $("#link_grid").val();
                var keyword = $("#saved_keyword").val();
                var password = $("#saved_password").val();
                var include_link = $("#include_link").val();
                var include_tooltips = $("#include_tooltips").val();
                $.cookie('marvelsig_position_grid', position_grid);
                $.cookie('marvelsig_costume_grid', costume_grid);
                $.cookie('marvelsig_level_grid', level_grid);
                $.cookie('marvelsig_flair_grid', flair_grid);
                $.cookie('marvelsig_link_grid', links);
                $.cookie('marvelsig_view_mode', view_mode);
                $.cookie('marvelsig_font', font);
                $.cookie('marvelsig_border_type', border_type);
                $.cookie('marvelsig_border_color', border_color);
                $.cookie('marvelsig_include_link', include_link);
                $.cookie('marvelsig_include_tooltips', include_tooltips);
                $.cookie('marvelsig_half_grids', half_grids);
                $.cookie('marvelsig_keyword', keyword);
                $.cookie('marvelsig_password', password);
                params = "position_grid=" + position_grid;
                params += "&costume_grid=" + costume_grid;
                params += "&flair_grid=" + flair_grid;
                params += "&level_grid=" + level_grid;
                params += "&keyword=" + keyword;
                params += "&password=" + password;
                params += "&include_link=" + include_link;
                params += "&include_tooltips=" + include_tooltips;
                if (font !== null) {
                    params = params + "&font=" + font.toString();
                }
                if (view_mode !== null) {
                    params = params + "&view_mode=" + view_mode.toString();
                }
                if (border_type !== null) {
                    params = params + "&border_type=" + border_type.toString();
                }
                if (border_color !== null) {
                    params = params + "&border_color=" + border_color;
                }
                if (half_grids !== null) {
                    params = params + "&half_grids=" + half_grids;
                }
                if (keyword && keyword.length > 0)
                {
                    if(!password || password.length <= 0)
                    {
                        alert("You must enter a password to save your sig in the database.  If you just want to save in cookies, please delete the keyword.");
                        return;
                    }
                    var url = "savesig.php";
                    console.log("URL: " + url + "?" + params);
                    $.ajax({
                        dataType: "json",
                        url: url,
                        data: params,
                        timeout: 10000,
                        success: function (data) {
                            finishSaveSig(data);
                        },
                        error: function (xhr, status, error)
                        {
                            var requestResponse = {
                                httpStatus: xhr.status,
                                error: xhr.statusText,
                                text: xhr.responseText,
                                passedstatus: status,
                                location: "AJAX"
                            };
                            handleError(requestResponse);
                        }
                    });
                }
                else
                {
                    alert("Sig saved in cookies!");
                    stopSpin();
                    $('#markdown_popup').fadeOut();
                }
            }

            function finishSaveSig(data)
            {
                stopSpin();
                console.log("Save returned: " + data.text);
                if (data.message === "SUCCESS")
                {
                    alert("Sig saved in database and cookies!");
                    $('#markdown_popup').fadeOut();
                    return;
                }
                else
                {
                    alert(data.message);
                    return;
                }
            }

            // saveSig had some validation in it at some point, but it posts back to the server
            // NOTE: the "action" field is used as a dirty flag.  It gets reset when the grids change.
            function loadSigFromDatabase() {
                doSpin();
                var keyword = $("#load_keyword").val();
                if (!keyword || keyword.length <= 0)
                {
                    alert("You must enter a keyword to load your sig.");
                    return;
                }
                var url = "loadsig.php";
                var params = "keyword=" + keyword;
                console.log("URL: " + url + "?" + params);
                $.cookie('marvelsig_keyword', keyword);
                $.ajax({
                    dataType: "json",
                    url: url,
                    data: params,
                    timeout: 10000,
                    success: function (data) {
                        finishLoadSig(data);
                    },
                    error: function (xhr, status, error)
                    {
                        var requestResponse = {
                            httpStatus: xhr.status,
                            error: xhr.statusText,
                            text: xhr.responseText,
                            passedstatus: status,
                            location: "AJAX"
                        };
                        handleError(requestResponse);
                    }
                });
            }

            function finishLoadSig(data)
            {
                console.log("Finishing load sig.");
                stopSpin();
                if (data.error)
                {
                    alert("Error loading sig: " + data.error);
                    return;
                }
                $("#font").val(data.font);
                $("#view_mode").val(data.view_mode);
                $("#position_grid").val(data.position_grid);
                $("#costume_grid").val(data.costume_grid);
                $("#flair_grid").val(data.flair_grid);
                $("#level_grid").val(data.level_grid);
                $("#border_type").val(data.border_type);
                $("#border_color").val(data.border_color);
                $("#half_grids").val(data.half_grids);
                $("#link_grid").val(data.link_grid);

                $.cookie('marvelsig_position_grid', data.position_grid);
                $.cookie('marvelsig_costume_grid', data.costume_grid);
                $.cookie('marvelsig_level_grid', data.level_grid);
                $.cookie('marvelsig_flair_grid', data.flair_grid);
                $.cookie('marvelsig_link_grid', data.link_grid);
                $.cookie('marvelsig_view_mode', data.view_mode);
                $.cookie('marvelsig_font', data.font);
                $.cookie('marvelsig_border_type', data.border_type);
                $.cookie('marvelsig_border_color', data.border_color);
                $.cookie('marvelsig_include_link', data.include_link);
                $.cookie('marvelsig_include_tooltips', data.include_tooltips);
                $.cookie('marvelsig_half_grids', data.half_grids);
                populateControls();
                $('#load_popup').fadeOut();
                buildGrid();
                previewSig();
            }

            function populateControls()
            {
                var num_characters = characters.length;
                var default_cols = 14;
                var default_rows = Math.ceil(num_characters / default_cols);
                if (!$('#hidden_cols').val())
                {
                    $('#hidden_cols').val(default_cols);
                }
                if (!$('#hidden_rows').val())
                {
                    $('#hidden_rows').val(default_rows);
                }
                var default_position_grid = "X-1Y-1";
                var i = 0;
                for (i = 1; i < num_characters; i++) {
                    default_position_grid = default_position_grid + "X-1Y-1";
                }
                var val = default_position_grid;
                if ($.cookie('marvelsig_position_grid'))
                {
                    val = $.cookie('marvelsig_position_grid');
                }
                while (val.length < (6 * num_characters)) {
                    val = val + "X-1Y-1";
                }
                $('#position_grid').val(val);
                for (i = 0; i < characters.length; i++)
                {
                    characters[i].grid_tag = getGridValue(val, parseInt(characters[i].char_index), 6);
                }
                // Create a default link grid, in case we don't have one already.
                var default_link_grid = "";
                for (i = 1; i < num_characters; i++) {
                    default_link_grid = default_link_grid + "|";
                }
                val = default_link_grid;
                if ($.cookie('marvelsig_link_grid'))
                {
                    val = $.cookie('marvelsig_link_grid');
                }

                var link_grid_len = (val.split(",").length - 1);
                while (link_grid_len < num_characters) {
                    val = val + "|";
                    link_grid_len += 1;
                }
                $('#link_grid').val(val);
                var links = val.split(",");
                for (i = 0; i < characters.length; i++)
                {
                    if (parseInt(characters[i].char_index) < links.length)
                    {
                        characters[i].link = links[parseInt(characters[i].char_index)];
                    }
                }
                // Repeat with the level grid
                var default_level_grid = "000";
                for (i = 1; i < num_characters; i++) {
                    default_level_grid = default_level_grid + "000";
                }
                val = default_level_grid;
                if ($.cookie('marvelsig_level_grid'))
                {
                    val = $.cookie('marvelsig_level_grid');
                }
                while (val.length < (3 * num_characters)) {
                    val = val + "000";
                }
                $('#level_grid').val(val);
                for (i = 0; i < characters.length; i++)
                {
                    var level_tag = getGridValue(val, parseInt(characters[i].char_index), 3);
                    // Calculate the level and prestige level
                    if (level_tag !== null) {
                        var new_level = parseInt(level_tag, 10);
                        if (new_level > 60 && new_level <= 120) {
                            characters[i].prestige = 1;
                        } else if (new_level > 120 && new_level <= 180) {
                            characters[i].prestige = 2;
                        } else if (new_level > 180 && new_level <= 240) {
                            characters[i].prestige = 3;
                        } else if (new_level > 240 && new_level <= 300) {
                            characters[i].prestige = 4;
                        } else if (new_level > 300 && new_level <= 360) {
                            characters[i].prestige = 5;
                        } else if (new_level > 360 && new_level <= 420) {
                            characters[i].prestige = 6;
                        }
                        characters[i].level = new_level - (60 * characters[i].prestige);
                    }
                }
                var default_costume_grid = "00";
                for (i = 1; i < num_characters; i++) {
                    default_costume_grid = default_costume_grid + "00";
                }
                val = default_costume_grid;
                if ($.cookie('marvelsig_costume_grid'))
                {
                    val = $.cookie('marvelsig_costume_grid');
                }
                while (val.length < (2 * num_characters)) {
                    val = val + "00";
                }
                $("#costume_grid").val(val);
                for (i = 0; i < characters.length; i++)
                {
                    characters[i].costume = getGridValue(val, parseInt(characters[i].char_index), 2);
                }
                var default_flair_grid = "000";
                for (i = 1; i < 4 * num_characters; i++) {
                    default_flair_grid = default_flair_grid + "000";
                }
                val = default_flair_grid;
                if ($.cookie('marvelsig_flair_grid'))
                {
                    val = $.cookie('marvelsig_flair_grid');
                }
                while (val.length < (4 * num_characters)) {
                    val = val + "000";
                }
                $('#flair_grid').val(val);
                for (i = 0; i < characters.length; i++)
                {
                    var char_index = parseInt(characters[i].char_index);
                    var flair_tag = getGridValue(val, 4 * char_index, 3);
                    if (flair_tag !== null) {
                        characters[i].flair = parseInt(flair_tag, 10);
                    }

                    // Extract the source
                    var source_tag = getGridValue(val, (4 * char_index) + 1, 3);
                    if (source_tag !== null) {
                        characters[i].source = parseInt(source_tag, 10);
                    }

                    // Extract the flair2
                    var flair2_tag = getGridValue(val, (4 * char_index) + 2, 3);
                    if (flair2_tag !== null) {
                        characters[i].flair2 = parseInt(flair2_tag, 10);
                    }
                }
                var default_half_grids = "";
                val = default_half_grids;
                if ($.cookie('marvelsig_half_grids'))
                {
                    val = $.cookie('marvelsig_half_grids');
                }
                $('#half_grids').val(val);

                if ($.cookie('marvelsig_font'))
                {
                    val = $.cookie('marvelsig_font');
                    $("#font").val(val);
                }


                if ($.cookie('marvelsig_view_mode'))
                {
                    val = $.cookie('marvelsig_view_mode');
                    $("#view_mode").val(val);
                }

                if ($.cookie('marvelsig_border_type'))
                {
                    val = $.cookie('marvelsig_border_type');
                    $("#border_type").val(val);
                }

                
                if ($.cookie('marvelsig_border_color'))
                {
                    val = $.cookie('marvelsig_border_color');
                    $("#border_color").val(val);
                }
                else
                {
                    val = "00AAFF";
                    $("#border_color").val(val);
                }
                

                if ($.cookie('marvelsig_include_link'))
                {
                    val = $.cookie('marvelsig_include_link');
                    $("#include_link").val(val);
                }

                if ($.cookie('marvelsig_include_tooltips'))
                {
                    val = $.cookie('marvelsig_include_tooltips');
                    $("#include_tooltips").val(val);
                }

                var keyword = $("#saved_keyword").val();
                var password = $("#saved_password").val();
                if (!keyword || keyword.length <= 0)
                {
                    keyword = $.cookie('marvelsig_keyword');
                    if (keyword)
                    {
                        $("#saved_keyword").val(keyword);
                        $("#load_keyword").val(keyword);
                    }
                }
                if (!password || password.length <= 0)
                {
                    password = $.cookie('marvelsig_password');
                    if (password)
                    {
                        $("#saved_password").val(password);
                    }
                }
            }

            // This generates some fake guids for the image maps.  jQuery supposedly has some internal guid generation code, but it is not exposed (and may break stuff if you try to use it)
            function s4() {
                return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
            }
            ;
            function guid() {
                return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
            }

            function generateSig(ispreview)
            {
                doSpin();
                // Get the parameters from the UI
                var font = $("#font").val();
                var view_mode = $("#view_mode").val();
                var position_grid = $("#position_grid").val();
                var costume_grid = $("#costume_grid").val();
                var flair_grid = $("#flair_grid").val();
                var level_grid = $("#level_grid").val();
                var border_type = $("#border_type").val();
                var border_color = $("#border_color").val();
                var half_grids = $("#half_grids").val();
                // Build the URL.
                var url = "position_grid=" + position_grid + "&level_grid=" + level_grid + "&costume_grid=" + costume_grid + "&flair_grid=" + flair_grid + "&version=2";
                if (font !== null) {
                    url = url + "&font=" + font.toString();
                }
                if (view_mode !== null) {
                    url = url + "&view_mode=" + view_mode.toString();
                }
                if (border_type !== null) {
                    url = url + "&border_type=" + border_type.toString();
                }
                if (border_color !== null) {
                    url = url + "&border_color=" + border_color;
                }
                if (half_grids !== null) {
                    url = url + "&half_grids=" + half_grids;
                }
                if (ispreview)
                {
                    url = "http://www.seanwmcginnis.com/marvelheroes/generatesig.php?" + url;
                    var title = "<div class='titleclause'>Your Sig</div>";
                    $("#preview").html(title + "<center><img src='" + url + "'></center>");
                    stopSpin();
                }
                else
                {
                    var params = url;
                    url = "imgur_upload.php";
                    console.log("URL: " + url + "?" + params);
                    $.ajax({
                        dataType: "json",
                        url: url,
                        data: params,
                        timeout: 10000,
                        success: function (data) {
                            finishGenerateSig(data);
                        },
                        error: function (xhr, status, error)
                        {
                            var requestResponse = {
                                httpStatus: xhr.status,
                                error: xhr.statusText,
                                text: xhr.responseText,
                                passedstatus: status,
                                location: "AJAX"
                            };
                            handleError(requestResponse);
                        }
                    });
                }
            }

            function handleError(ret)
            {
                if (!ret)
                {
                    alert("Something is borked!");
                }
                else
                {
                    alert("An error occurred: " + JSON.stringify(ret));
                }
                stopSpin();
            }

            // This function builds the markdown code, which is actually no longer markdown, but rather straight HTML
            function finishGenerateSig(response) {
                if (!response)
                {
                    handleError(null);
                    return;
                }
                if (response.error)
                {
                    handleError(response);
                    return;
                }
                var id = response.data.id;
                var imgur = 'https://i.imgur.com/' + id + '.png';
                var title = "<div class='titleclause'>Your Sig</div>";
                $("#preview").html(title + "<center><img src='" + imgur + "'></center>");
                // Get the settings from the UI fields.  These setting are covered in the sig-generation code.
                var position_grid = $("#position_grid").val();
                var costume_grid = $("#costume_grid").val();
                var half_grids = $("#half_grids").val();
                var links = $("#link_grid").val().split("|");
                // Except these two.  include_link determines whether a link to my thread on the forums should be included in the markdown
                var include_link = $("#include_link").val();
                // Include tooltips indicates whether a tooltip image map should be generated, and what kind.
                var include_tooltips = $("#include_tooltips").val();
                // Begin the markdown with the image itself
                var markdown = "<img src='" + imgur + "' alt='My super fantastic custom sig'";
                if (include_tooltips > 0) {
                    // If we're doing tooltips, generate a unique name for the image map.
                    var map_name = guid();
                    markdown += " usemap='#" + map_name + "'>";
                    markdown += "<map name='" + map_name + "'>";
                    var char_index = 0;
                    var cos_index = 0;
                    var coords = "";
                    var grid_tag = "";
                    var title = "";
                    // Iterate through the character indices
                    for (char_index = 0; char_index < characters.length; char_index++) {
                        var hero = null;
                        for(var i=0; i < characters.length; i++)
                        {
                            if(parseInt(characters[i].char_index) === char_index)
                            {
                                hero = characters[i];
                                break;
                            }
                        }
                        // Get the location of the character
                        grid_tag = getGridValue(position_grid, char_index, 6);
                        cos_index = parseInt(getGridValue(costume_grid, char_index, 2), 10);
                        // If the character is not on the grid, then skip
                        if (grid_tag === null) {
                            grid_tag = "X-1Y-1";
                        }
                        if (grid_tag !== "X-1Y-1") {
                            // Parse the coordinates
                            var x = parseInt(grid_tag.substr(1, 2), 10);
                            var y = parseInt(grid_tag.substr(4, 2), 10);
                            // Put togehter a title, starting with the character's name.
                            title = hero.char_name;
                            // Find the index of the character's costume in the arrays, and pull it.
                            for (var i = 0; i < hero.costume_indices.length; i++) {
                                if (parseInt(hero.costume_indices[i], 10) === cos_index) {
                                    var cos_name = hero.costume_names[i].replace("'", "&apos;");
                                    if(cos_name !== hero.char_name)
                                    {
                                        title = title + " (" + cos_name + ")";
                                    }
                                    break;
                                }
                            }
                            // If we are including the level add that to the title.
                            if (include_tooltips === 1) {
                                if (hero.level > 0) {
                                    title = title + ": Level " + hero.level.toString();
                                    if (hero.prestige === 1) {
                                        title = title + " Green";
                                    } else if (hero.prestige === 2) {
                                        title = title + " Blue";
                                    } else if (hero.prestige === 3) {
                                        title = title + " Purple";
                                    } else if (hero.prestige === 4) {
                                        title = title + " Orange";
                                    } else if (hero.prestige === 5) {
                                        title = title + " Red";
                                    } else if (hero.prestige === 6) {
                                        title = title + " Cosmic";
                                    }
                                }
                            }
                            var cx = 0;
                            var gridx = 0;
                            for (cx = 0; cx < x; cx++) {
                                var temp_tag = "X" + pad(cx.toString(), 2) + "Y" + pad(y.toString(), 2);
                                if (half_grids.indexOf(temp_tag) < 0) {
                                    gridx += 45;
                                } else {
                                    gridx += 22.5;
                                }
                            }
                            // Calculate the coords, which are just 45 * x and 45 * y
                            coords = (gridx).toString() + "," + (45 * y).toString() + "," + (gridx + 45).toString() + "," + ((45 * y) + 45).toString();
                            // Add the final map entry to the markdown
                            markdown += "<area shape='rect' coords='" + coords + "' title='" + title + "'";
                            if (links[char_index].length > 0) {
                                markdown += " href='" + links[char_index] + "' target='_blank'";
                            }
                            markdown += ">";
                        }
                    }
                    // Close the map
                    markdown += "</map>";
                } else {
                    markdown = markdown + ">";
                }
                var link_text = "<a href='https://forums.marvelheroes.com/discussion/43655/hero-roster-2-x/p1'>**Hero Roster 2.x**</a>";
                // Add the link, if desired
                if (include_link === 1) {
                    markdown = markdown + "\n\n" + link_text;
                }
                $("#markdown").val(markdown);
                $('#markdown_popup').fadeIn();
                stopSpin();
            }

            // Similar to the above, this generates the preview -- which just passes the configuration to the sig code.
            function previewSig() {
                generateSig(true);
                positionElements();
            }

            // Similar to the above, this generates the preview -- which just passes the configuration to the sig code.
            function createSig() {
                generateSig(false);
                positionElements();
            }
            // This function writes the character array to the hidden fields (so we can make URLs, and post stuff back to the server)
            function writeCharacters() {
                var i = 0;
                var new_position_grid = "";
                var new_costume_grid = "";
                var new_level_grid = "";
                var new_flair_grid = "";
                var new_link_grid = "";
                // This is stupid simple -- since the grids are character_index-indexed, just iterate through the character list and concat the relevant info to better
                for (i = 0; i < characters.length; i++) {
                    var char = null;
                    for (var j = 0; j < characters.length; j++)
                    {
                        if (parseInt(characters[j].char_index) === i)
                        {
                            char = characters[j];
                            break;
                        }
                    }
                    new_position_grid = new_position_grid + char.grid_tag;
                    // Make sure that numeric fields are padded correctly
                    new_costume_grid = new_costume_grid + pad(char.costume.toString(), 2);
                    var level = char.level + (60 * char.prestige);
                    new_level_grid = new_level_grid + pad(level.toString(), 3);
                    new_flair_grid = new_flair_grid + pad(char.flair.toString(), 3) + pad(char.source.toString(), 3) + pad(char.flair2.toString(), 3) + "000";
                    new_link_grid = new_link_grid + char.link + "|";
                }
                // Set the hidden fields
                $("#position_grid").val(new_position_grid);
                $("#costume_grid").val(new_costume_grid);
                $("#level_grid").val(new_level_grid);
                $("#flair_grid").val(new_flair_grid);
                $("#link_grid").val(new_link_grid);
                // Flag the sig as dirty
                $("#action").val("");
            }

            // Calculate the size of the grid (for dynamic growing of the grid)
            function calculateGridSize() {
                var position_grid = $("#position_grid").val();
                // 14 X 2 is the min size
                var new_grid_cols = 14;
                var new_grid_rows = 2;
                // Iterate over all of the characters
                for (i = 0; i < characters.length; i++) {
                    // Get the grid tag
                    var grid_tag = getGridValue(position_grid, i, 6);
                    if (grid_tag === "X-1Y-1") {
                        continue;
                    }
                    // Parse out the cols; make the new col size the max index + 2 (so, 1-based, plus a blank row)
                    if (parseInt(grid_tag.substr(1, 2), 10) + 2 > new_grid_cols) {
                        new_grid_cols = parseInt(grid_tag.substr(1, 2), 10) + 2;
                    }

                    // Do the same thing for tows
                    var row = parseInt(grid_tag.substr(4, 2), 10);
                    if (row + 2 > new_grid_rows) {
                        new_grid_rows = row + 2;
                    }
                }
                // Set the new size into the hidden fields.
                $("#hidden_rows").val(new_grid_rows.toString());
                $("#hidden_cols").val(new_grid_cols.toString());
            }

            function finishLoadFlair(data) {
                console.log("Finishing load flair.");
                var i = 0;
                for (i = 0; i < data.length; i++)
                {
                    var f = new MarvelFlair(data[i].flair_index, data[i].flair_name, data[i].flair_file, data[i].flair_position, data[i].x_offset, data[i].y_offset);
                    flair.push(f);
                }
                stopSpin();
                console.log("Finished load flair.");
                console.log(JSON.stringify(flair));
                loadFonts();
            }

            function populateCharacterPen()
            {
                var main_menu = "";
                var xoff = $('#costumepen').position().left + 8.75;
                var max_x = $('#costumepen').position().left + $('#costumepen').width();
                var yoff = $('#costumepen').position().top + 8.75;
                var button_name = "";
                var menu_name = "";
                var i = 0;
                for (i = 0; i < characters.length; i++)
                {
                    // Create the button (the div) and the image (which we need to change when the costume changes), as well as the level label
                    var button_name = pad(characters[i].char_index.toString(), 2) + "_button";
                    var image_name = pad(characters[i].char_index.toString(), 2) + "_displayimage";
                    var ll_name = pad(characters[i].char_index.toString(), 2) + "_levellabel";
                    var fi_name = pad(characters[i].char_index.toString(), 2) + "_flairimage";
                    var fi2_name = pad(characters[i].char_index.toString(), 2) + "_flair2image";
                    var si_name = pad(characters[i].char_index.toString(), 2) + "_sourceimage";
                    var imagefile = "";
                    if (characters[i].costume_names.length > 0)
                    {
                        imagefile = characters[i].image_files[1];
                    }
                    else
                    {
                        imagefile = characters[i].image_files[0];
                    }

                    var button_title = characters[i].char_name;
                    // Put the HTML together
                    var main_menu = "<div class='CharacterButton ui-widget-content' title='" + button_title + "' id='" + button_name + "' style='left:" + xoff.toString() + "px; top:" + yoff.toString() + "px'><img id='" + image_name + "' class='CharacterImage' src='" + imagefile + "'  /><div id='" + ll_name + "' style='left:25px; top:30px' name='" + ll_name + "' class='prestige_level_0'></div><img id='" + fi_name + "' style='left:34px; top:3px; display:none;' name='" + fi_name + "' class='flair_image' src=''></img>";
                    main_menu += "<img id='" + si_name + "' style='display:none;' name='" + si_name + "' class='source_image' src=''></img><img id='" + fi2_name + "' style='left:3px; top:3px; display:none;' name='" + fi2_name + "' class='flair2_image' src=''></img></div>";
                    $('#outerborder').append($(main_menu));
                    characters[i].home_x = xoff;
                    characters[i].home_y = yoff;
                    xoff = xoff + (45 + 8.75);
                    if (xoff >= max_x)
                    {
                        xoff = $('#costumepen').position().left + 8.75;
                        yoff += (45 + 8.75);
                    }
                }
                $("#costumepen").css({height: yoff + 45 + 8.75});
            }

            function finishLoadFonts(data)
            {
                console.log("Finishing load fonts.");
                var i = 0;
                for (i = 0; i < data.length; i++)
                {
                    $('#font').append($('<option/>', {
                        value: data[i].index,
                        text: data[i].name
                    }));
                }
                stopSpin();
                console.log("Finished load fonts.");
                finishInit();
            }

            // Load the characters from the hidden fields into the characters array
            function finishLoadCharacters(data) {
                // Pull the grids.
                console.log("Finishing load characters.");
                var position_grid = $("#position_grid").val();
                var costume_grid = $("#costume_grid").val();
                var flair_grid = $("#flair_grid").val();
                var links = $("#link_grid").val().split("|");
                var num_chars = data.length;
                var i = 0;
                var char_index = "";
                var level_grid = $("#level_grid").val();
                // For each character...
                for (i = 0; i < num_chars; i++) {
                    char_index = pad(data[i].character_index, 2);
                    // Derive the various control names; we save these so we can monkey about with the controls later.
                    var button_name = "#" + char_index + "_button";
                    var menu_name = "#" + char_index + "_costumes";
                    var level_name = "#" + char_index + "_level";
                    var levellabel_name = "#" + char_index + "_levellabel";
                    var white_name = "#" + char_index + "_white";
                    var green_name = "#" + char_index + "_green";
                    var blue_name = "#" + char_index + "_blue";
                    var purple_name = "#" + char_index + "_purple";
                    var orange_name = "#" + char_index + "_orange";
                    var red_name = "#" + char_index + "_red";
                    var yellow_name = "#" + char_index + "_yellow";
                    var flair_name = "#" + char_index + "_flair";
                    var flair2_name = "#" + char_index + "_flair2";
                    var source_name = "#" + char_index + "_source";
                    var flairimage_name = "#" + char_index + "_flairimage";
                    var flair2image_name = "#" + char_index + "_flair2image";
                    var sourceimage_name = "#" + char_index + "_sourceimage";
                    var link_name = "#" + char_index + "_link";
                    // Create a grid tag.
                    var grid_tag = getGridValue(position_grid, i, 6);
                    if (grid_tag === null) {
                        grid_tag = "X-1Y-1";
                    }
                    // Extract the "home coordinates" -- where the character lives in the character pen so we can put it back there when the user drags it out of the grid.
                    var home_x = 0;
                    var home_y = 0;
                    // Create a new hero.
                    var m = new MarvelHero(data[i].character_index, home_x, home_y, grid_tag, button_name, menu_name, level_name, white_name, green_name, blue_name, purple_name, orange_name, red_name, yellow_name, flair_name, levellabel_name, flairimage_name, source_name, sourceimage_name, link_name, flair2_name, flair2image_name);
                    m.char_name = data[i].character_name;
                    m.costume_names = data[i].costume_name;
                    m.costume_indices = data[i].costume_index;
                    m.image_files = data[i].image_file;
                    m.link = links[i];
                    characters.push(m);
                }
                stopSpin();
                console.log("Finished load characters.");
                loadFlair();
            }

            // Remove everything from the grid.  This is, thankfully, just a matter of resetting the position grid to all "X-1Y-1".
            function clearLayout() {
                var i = 0;
                for (i = 0; i < characters.length; i++) {
                    var hero = characters[i];
                    $(hero.myButton).css({
                        top: hero.home_y,
                        left: hero.home_x
                    });
                    hero.grid_tag = "X-1Y-1";
                    $(hero.myLevelLabel).hide();
                    $(hero.myFlairImage).hide();
                    $(hero.myFlair2Image).hide();
                }
                writeCharacters();
                buildGrid();
            }

            // This puts every hero in the grid in alphabetical order, similar to how V1 worked.
            function defaultLayout() {
                var i = 0;
                var cols = 14;
                var y = 0;
                var x = 0;
                // This is tricky.  Because of some weirdness, I pass down a list of character indices, ordered by display order, which serves as a map between display order and char index.
                // What you see here is iterating over display order, and pulling the corresponding char index, and then placing the character.
                for (i = 0; i < characters.length; i++) {
                    var hero = characters[i];
                    var grid_tag = "X" + pad(x.toString(), 2) + "Y" + pad(y.toString(), 2);
                    hero.grid_tag = grid_tag;
                    x += 1;
                    if (x >= cols) {
                        x = 0;
                        y += 1;
                    }
                }
                writeCharacters();
                buildGrid();
                $("#hidden_cols").val(cols.toString());
                $("#hidden_rows").val(y.toString());
            }

            // Pad a string with 0s
            function pad(str, max) {
                return str.length < max ? pad("0" + str, max) : str;
            }

            // Close all character menus
            function closeAllMenus() {
                for (var i = 0; i < characters.length; i++) {
                    $(characters[i].myMenu).hide();
                }
                // Write the grid
                writeCharacters();
                // Render
                buildGrid();
            }

            // Show a character's menu
            function showCharacterMenu(char_index) {
                var hero = null;
                for (var i = 0; i < characters.length; i++) {
                    if (parseInt(characters[i].char_index) === parseInt(char_index)) {
                        hero = characters[i];
                    } else {
                        $(characters[i].myMenu).hide();
                    }
                }
                // If the hero is not placed, do nothing.
                if (hero.grid_tag === "X-1Y-1") {
                    return;
                }
                // Put the menu on top of the button
                $(hero.myMenu).css({
                    top: $(hero.myButton).position().top - 28.75,
                    left: $(hero.myButton).position().left - 8.75
                });
                // Set the level correctly.
                $(hero.myLevel).val(hero.level.toString());
                $(hero.myLink).val(hero.link);
                // Set the flair index correctly
                $(hero.myFlair).val(hero.flair);
                $(hero.myFlair2).val(hero.flair2);
                // Set the flair index correctly
                $(hero.mySource).val(hero.source);
                // Show the menu
                $(hero.myMenu).show('fast');
                // Focus on the level text.
                $(hero.myLevel).focus();
            }

            // Select a hero's costume.
            function selectCostume(char_index, cos_index) {
                // Find the hero
                var hero = null;
                for (var i = 0; i < characters.length; i++)
                {
                    if (parseInt(characters[i].char_index) === parseInt(char_index))
                    {
                        hero = characters[i];
                        break;
                    }
                }
                if (hero !== null)
                {
                    console.log("Setting costume: " + hero.char_name + " to " + cos_index);
                    // Set the costume index
                    hero.costume = parseInt(cos_index, 10);
                }
                // Write the grid
                writeCharacters();
                // Render
                buildGrid();
                // Hide the menu
                $(hero.myMenu).hide('fast');
                // You'll see the above a lot; I based the render code on the hidden fields, so most of these functions just save and re-render, which cuts out a lot of work.
            }

            function renderFlair(char_index) {
                var hero = null;
                for (var i = 0; i < characters.length; i++)
                {
                    if (parseInt(characters[i].char_index) === parseInt(char_index))
                    {
                        hero = characters[i];
                        break;
                    }
                }
                if (hero.flair > 0) {
                    for (var i = 0; i < flair.length; i++) {
                        if (flair[i].flair_index === hero.flair) {
                            $(hero.myFlairImage).attr("src", "glyphicons_free/glyphicons/png/" + flair[i].flair_file);
                            if (flair[i].flair_position === 1) {
                                if (flair[i].x_offset === 0 && flair[i].y_offset === 0) {
                                    $(hero.myFlairImage).css({
                                        left: 0,
                                        top: 22,
                                        bottom: 'auto'
                                    });
                                } else {
                                    $(hero.myFlairImage).css({
                                        left: flair[i].x_offset,
                                        bottom: 45 - flair[i].y_offset,
                                        top: 'auto'
                                    });
                                }
                            }
                            $(hero.myFlairImage).show();
                            break;
                        }
                    }
                } else {
                    $(hero.myFlairImage).hide();
                }
                if (hero.source > 0) {
                    for (var i = 0; i < flair.length; i++) {
                        if (flair[i].flair_index === hero.source) {
                            $(hero.mySourceImage).attr("src", "glyphicons_free/glyphicons/png/" + flair[i].flair_file);
                            if (flair[i].flair_position === 1) {
                                if (flair[i].x_offset === 0 && flair[i].y_offset === 0) {
                                    $(hero.mySourceImage).css({
                                        left: 0,
                                        top: 22,
                                        bottom: 'auto'
                                    });
                                } else {
                                    $(hero.mySourceImage).css({
                                        left: flair[i].x_offset,
                                        bottom: flair[i].y_offset,
                                        top: 'auto'
                                    });
                                }
                            }
                            $(hero.mySourceImage).show();
                            break;
                        }
                    }
                } else {
                    $(hero.mySourceImage).hide();
                }
                if (hero.flair2 > 0) {
                    console.log("Rendering flair2: " + hero.flair2.toString());
                    for (var i = 0; i < flair.length; i++) {
                        if (flair[i].flair_index === hero.flair2) {
                            console.log("Found file: " + flair[i].flair_file);
                            $(hero.myFlair2Image).attr("src", "glyphicons_free/glyphicons/png/" + flair[i].flair_file);
                            if (flair[i].flair_position === 1) {
                                if (flair[i].x_offset === 0 && flair[i].y_offset === 0) {
                                    $(hero.myFlair2Image).css({
                                        left: 0,
                                        top: 22,
                                        bottom: 'auto'
                                    });
                                } else {
                                    $(hero.myFlair2Image).css({
                                        left: flair[i].x_offset,
                                        top: flair[i].y_offset,
                                        bottom: 'auto'
                                    });
                                }
                            }
                            else if (flair[i].flair_position === 2)
                            {
                                $(hero.myFlair2Image).css({
                                    left: flair[i].x_offset,
                                    top: flair[i].y_offset,
                                    bottom: 'auto'
                                });
                            }
                            $(hero.myFlair2Image).show();
                            break;
                        }
                    }
                } else {
                    $(hero.myFlair2Image).hide();
                }
            }

            function flairChange(char_index) {
                var hero = null;
                for (var i = 0; i < characters.length; i++)
                {
                    if (parseInt(characters[i].char_index) === parseInt(char_index))
                    {
                        hero = characters[i];
                        break;
                    }
                }
                var flair_index = parseInt($(hero.myFlair).val(), 10);
                hero.flair = flair_index;
                renderFlair(char_index);
            }

            function flair2Change(char_index) {
                var hero = null;
                for (var i = 0; i < characters.length; i++)
                {
                    if (parseInt(characters[i].char_index) === parseInt(char_index))
                    {
                        hero = characters[i];
                        break;
                    }
                }
                var flair2_index = parseInt($(hero.myFlair2).val(), 10);
                hero.flair2 = flair2_index;
                renderFlair(char_index);
            }

            function linkChange(char_index) {
                var hero = null;
                for (var i = 0; i < characters.length; i++)
                {
                    if (parseInt(characters[i].char_index) === parseInt(char_index))
                    {
                        hero = characters[i];
                        break;
                    }
                }
                hero.link = $(hero.myLink).val();
            }

            function sourceChange(char_index) {
                var hero = null;
                for (var i = 0; i < characters.length; i++)
                {
                    if (parseInt(characters[i].char_index) === parseInt(char_index))
                    {
                        hero = characters[i];
                        break;
                    }
                }
                var source_index = parseInt($(hero.mySource).val(), 10);
                hero.source = source_index;
                renderFlair(char_index);
            }

            // This was a bit of a production, since it has to change the button state.  Seriously, that's what all this code is for.'
            function prestigeChange(char_index, p_level) {
                var hero = null;
                for (var i = 0; i < characters.length; i++)
                {
                    if (parseInt(characters[i].char_index) === parseInt(char_index))
                    {
                        hero = characters[i];
                        break;
                    }
                }
                // Get the prestige level
                hero.prestige = p_level;
                // For each prestige level, set the hero's prestige buttons correctly'
                if (p_level === 0) {
                    $(hero.myWhite).attr("src", "images_new/ui_white_on.png");
                    $(hero.myLevelLabel).addClass("prestige_level_0");
                } else {
                    $(hero.myWhite).attr("src", "images_new/ui_white_off.png");
                    $(hero.myLevelLabel).removeClass("prestige_level_0");
                }
                if (p_level === 1) {
                    $(hero.myGreen).attr("src", "images_new/ui_green_on.png");
                    $(hero.myLevelLabel).addClass("prestige_level_1");
                } else {
                    $(hero.myGreen).attr("src", "images_new/ui_green_off.png");
                    $(hero.myLevelLabel).removeClass("prestige_level_1");
                }
                if (p_level === 2) {
                    $(hero.myBlue).attr("src", "images_new/ui_blue_on.png");
                    $(hero.myLevelLabel).addClass("prestige_level_2");
                } else {
                    $(hero.myBlue).attr("src", "images_new/ui_blue_off.png");
                    $(hero.myLevelLabel).removeClass("prestige_level_2");
                }
                if (p_level === 3) {
                    $(hero.myPurple).attr("src", "images_new/ui_purple_on.png");
                    $(hero.myLevelLabel).addClass("prestige_level_3");
                } else {
                    $(hero.myPurple).attr("src", "images_new/ui_purple_off.png");
                    $(hero.myLevelLabel).removeClass("prestige_level_3");
                }
                if (p_level === 4) {
                    $(hero.myOrange).attr("src", "images_new/ui_orange_on.png");
                    $(hero.myLevelLabel).addClass("prestige_level_4");
                } else {
                    $(hero.myOrange).attr("src", "images_new/ui_orange_off.png");
                    $(hero.myLevelLabel).removeClass("prestige_level_4");
                }
                if (p_level === 5) {
                    $(hero.myRed).attr("src", "images_new/ui_red_on.png");
                    $(hero.myLevelLabel).addClass("prestige_level_5");
                } else {
                    $(hero.myRed).attr("src", "images_new/ui_red_off.png");
                    $(hero.myLevelLabel).removeClass("prestige_level_5");
                }
                if (p_level === 6) {
                    $(hero.myYellow).attr("src", "images_new/ui_yellow_on.png");
                    $(hero.myLevelLabel).addClass("prestige_level_6");
                } else {
                    $(hero.myYellow).attr("src", "images_new/ui_yellow_off.png");
                    $(hero.myLevelLabel).removeClass("prestige_level_6");
                }
            }

            // Change the hero's level
            function levelChange(char_index) {
                console.log("Changing level: " + char_index.toString());
                var hero = null;
                for (var i = 0; i < characters.length; i++)
                {
                    if (parseInt(characters[i].char_index) === parseInt(char_index))
                    {
                        hero = characters[i];
                        break;
                    }
                }
                var new_level = 0;
                // Check for syntax errors and boundary conditions
                if ($(hero.myLevel).val().length > 0) {
                    new_level = parseInt($(hero.myLevel).val(), 10);
                    if (isNaN(new_level)) {
                        alert("Check the level value entered -- it is not an integer.");
                        return;
                    } else {
                        if (new_level > 60) {
                            alert("There is no level higher than 60; please try again.");
                            return;
                        }
                        if (new_level < 0) {
                            alert("There is no level lower than 0; please try again.");
                            return;
                        }
                    }
                }
                // Set the level
                hero.level = new_level;
                if (hero.level > 0) {
                    // Redraw the level tag.
                    $(hero.myLevelLabel).html(new_level.toString());
                    $(hero.myLevelLabel).show();
                } else {
                    $(hero.myLevelLabel).hide();
                    prestigeChange(char_index, 0);
                }
            }

            // Show that blue thingy around the character images.
            function showSelector(button) {
                var element = $('#c_selector').detach();
                $(button).append(element);
                $("#c_selector").show();
            }

            // Show that blue thingy around the costumes
            function showCostumeSelector(control) {
                var element = $('#c_selector').detach();
                $(control).append(element);
                $("#c_selector").show();
            }

            // Hide the blue thingy.
            function hideSelector() {
                $("#c_selector").hide();
            }

            // Because everything is growing or shrinking or bopping about, we have to dynamically move elements.  You can see how this does it -- it just offsets the different y coordinates by the height of the above elements.
            function positionElements() {
                var win_width = $(window).width();
                if (win_width === 0)
                {
                    win_width = window.innerWidth;
                }
                if (win_width === 0)
                {
                    win_width = $(window).attr('screen').width;
                }
                var outer_left = win_width - $("#outerborder").width();
                $("#outerborder").css({
                    left: outer_left / 2
                });
                var rows = parseInt($("#hidden_rows").val(), 10);
                var cols = parseInt($("#hidden_cols").val(), 10);
                var outer_width = 8.75 + (53.75 * cols);
                $("#outerborder").css({
                    width: outer_width
                });
                var x = (outer_width - $("#costumepen").width()) / 2;
                var offset = x - $("#costumepen").position().left;
                for (var index = 0; index < characters.length; index++) {
                    // If there is a character in this grid square...
                    characters[index].home_x += offset;
                    if (characters[index].grid_tag === "X-1Y-1") {
                        $(characters[index].myButton).css({
                            left: characters[index].home_x
                        });
                    }
                }
                $("#costumepen").css({
                    left: x
                });
                var y = $("#costumepen").position().top + $("#costumepen").height() + 30;
                x = (outer_width - $("#sig_grid").width()) / 2;
                $("#sig_grid").css({
                    top: y,
                    left: x
                });
                y += $("#sig_grid").height() + 30;
                x = (outer_width - $("#controls").width()) / 2;
                $("#controls").css({
                    top: y,
                    left: x
                });
                y += $("#controls").height() + 30;
                x = (outer_width - $("#preview").width()) / 2;
                $("#preview").css({
                    top: y,
                    left: x
                });
                y += (45 * rows);
                x = (outer_width - $("#footer").width()) / 2;
                $("#footer").css({
                    top: y,
                    left: x
                });
                y += $("#footer").height() + 100;
                $("#outerborder").height(y);
                $("body").height(y + 100);
            }
            var opts = {
                lines: 11, // The number of lines to draw
                length: 15, // The length of each line
                width: 10, // The line thickness
                radius: 30, // The radius of the inner circle
                corners: 1, // Corner roundness (0..1)
                rotate: 0, // The rotation offset
                direction: 1, // 1: clockwise, -1: counterclockwise
                color: '#00aaff', // #rgb or #rrggbb
                speed: 0.6, // Rounds per second
                trail: 60, // Afterglow percentage
                shadow: false, // Whether to render a shadow
                hwaccel: false, // Whether to use hardware acceleration
                className: 'spinner', // The CSS class to assign to the spinner
                zIndex: 2e9, // The z-index (defaults to 2000000000)
                top: 'auto', // Top position relative to parent in px
                left: 'auto' // Left position relative to parent in px
            };
            var spinner = null;
            var spinner_div = 0;
            function doSpin()
            {
                if (spinner === null) {
                    spinner = new Spinner(opts).spin(spinner_div);
                } else {
                    spinner.spin(spinner_div);
                }
            }

            function stopSpin()
            {
                if (spinner !== null)
                {
                    spinner.stop(spinner_div);
                }
            }

            // Do some initial stuff.
            function finishInit()
            {
                console.log("Init 0.");
                populateCharacterPen();
                console.log("Init 1.");
                buildCostumeMenus();
                console.log("Init 2.");
                populateControls();
                console.log("Init 3.");
                hookupControls();
                console.log("Init 4.");
                buildGrid();
                console.log("Init 5.");
                $("body").bind("mouseup touchstart", function (evt) {
                    closeAllMenus();
                });
                previewSig();
            }

            function init() {
                $('#markdown_popup').hide();
                $('#load_popup').hide();
                spinner_div = $('#spinner').get(0);
                loadCharacters();
            }

            // The same convenience functions for getting and setting tokens from a fix-length token string.
            function getGridValue(inGrid, inIndex, inGridCellSize) {
                if (inGrid.length <= (inIndex * inGridCellSize)) {
                    return null;
                }
                var offset = inIndex * inGridCellSize;
                return inGrid.substr(offset, inGridCellSize);
            }

            function setGridValue(inGrid, inValue, inIndex, inGridCellSize) {
                if (inGrid.length <= (inIndex * inGridCellSize)) {
                    return null;
                }
                var offset = inIndex * inGridCellSize;
                var new_val = pad(inValue, inGridCellSize);
                return inGrid.substr(0, offset) + new_val + inGrid.substr(offset + inGridCellSize);
            }

            function removeGridValue(inGrid, inIndex, inGridCellSize) {
                if (inGrid.length <= (inIndex * inGridCellSize)) {
                    return null;
                }
                var offset = inIndex * inGridCellSize;
                return inGrid.substr(0, offset) + inGrid.substr(offset + inGridCellSize);
            }

            // THis function handles what happens when a character is dragged and then dropped on the interface
            function dropCharacter(char_index, ui) {
                var hero = null;
                var i = 0;
                for (i = 0; i < characters.length; i++)
                {
                    if (parseInt(characters[i].char_index) === parseInt(char_index))
                    {
                        hero = characters[i];
                        break;
                    }
                }
                var drop_x = ui.position.left + 22.5;
                var drop_y = ui.position.top + 22.5;
                var grid_cols = $("#hidden_cols").val();
                var grid_rows = $("#hidden_rows").val();
                var rows = parseInt(grid_rows, 10);
                var cols = parseInt(grid_cols, 10);
                var y = 0;
                var x = 0;
                var grid_tag = "";
                var index = 0;
                var hit = false;
                var level_label_name = "#" + pad(char_index.toString(), 2) + "_levellabel";
                // Iterate over the grid and see if the drop coordinates are inside of a given grid position
                for (y = 0; y < rows; y++) {
                    for (x = 0; x < cols; x++) {
                        grid_tag = "X" + pad(x.toString(), 2) + "Y" + pad(y.toString(), 2);
                        var id = "#" + grid_tag + "_gridblock";
                        if (drop_x >= $(id).position().left && drop_x <= $(id).position().left + 45 && drop_y >= $(id).position().top && drop_y <= $(id).position().top + 45) {
                            hit = true;
                            break;
                        }
                    }
                    if (hit)
                        break;
                }
                // If there was a hit...
                if (hit) {
                    // See if something is already in the grid
                    var clasher = null;
                    for (i = 0; i < characters.length; i++) {
                        if (characters[i].grid_tag === grid_tag) {
                            clasher = characters[i];
                            break;
                        }
                    }
                    // If there was something in the grid, swap it to wherever the thing we dropped was.
                    if (clasher !== null) {
                        clasher.grid_tag = hero.grid_tag;
                        if (clasher.grid_tag === "X-1Y-1") {
                            $(clasher.myButton).css({
                                top: clasher.home_y,
                                left: clasher.home_x
                            });
                        }
                    }
                    // Set the hero's grid tag'
                    hero.grid_tag = grid_tag;
                    // Show the hero's level, now that it is on the grid.'
                    if (hero.level > 0) {
                        $(hero.myLevelLabel).show();
                    } else {
                        $(hero.myLevelLabel).hide();
                    }
                    if (hero.flair >= 0) {
                        $(hero.myFlairImage).show();
                    }
                    if (hero.flair2 >= 0) {
                        $(hero.myFlair2Image).show();
                    }
                    if (hero.source >= 0) {
                        $(hero.mySourceImage).show();
                    }
                    removeHalfGrid(grid_tag);
                } else {
                    // If there was no hit, then put the hero back in the character pen.
                    $(hero.myButton).css({
                        top: hero.home_y,
                        left: hero.home_x + $("#costumepen").position().left
                    });
                    hero.grid_tag = "X-1Y-1";
                    $(hero.myLevelLabel).hide();
                    if (hero.flair >= 0) {
                        $(hero.myFlairImage).hide();
                    }
                    if (hero.flair2 >= 0) {
                        $(hero.myFlair2Image).hide();
                    }
                    if (hero.source >= 0) {
                        $(hero.mySourceImage).hide();
                    }
                }
                writeCharacters();
                buildGrid();
            }

            function removeHalfGrid(grid_tag)
            {
                var half_grids = $("#half_grids").val();
                var index = 0;
                var num_entries = half_grids.length / 6;
                var found = false;
                for (index = 0; index < num_entries; index++) {
                    if (getGridValue(half_grids, index, 6) === grid_tag) {
                        half_grids = removeGridValue(half_grids, index, 6);
                        found = true;
                        break;
                    }
                }
                if (found)
                {
                    $("#half_grids").val(half_grids);
                }
            }

            function toggleHalfWhole(evt) {
                var grid_tag = "X" + pad(evt.data.gridx.toString(), 2) + "Y" + pad(evt.data.gridy.toString(), 2);
                var half_grids = $("#half_grids").val();
                var index = 0;
                var num_entries = half_grids.length / 6;
                var found = false;
                for (index = 0; index < num_entries; index++) {
                    if (getGridValue(half_grids, index, 6) === grid_tag) {
                        half_grids = removeGridValue(half_grids, index, 6);
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    half_grids = half_grids + grid_tag;
                }
                $("#half_grids").val(half_grids);
                buildGrid();
            }

            // This is the render function.
            function buildGrid() {
                calculateGridSize();
                positionElements();
                // Remove the existing "drop zones" from the sig area.
                $("div[id$='_gridblock']").remove();
                var grid_cols = $("#hidden_cols").val();
                var grid_rows = $("#hidden_rows").val();
                var half_grids = $("#half_grids").val();
                var rows = parseInt(grid_rows, 10);
                var cols = parseInt(grid_cols, 10);
                var height = 8.75 + (rows * (45 + 8.75));
                var width = 8.75 + (cols * (45 + 8.75));
                $("#sig_grid").css({
                    height: height,
                    width: width
                });
                positionElements();
                // Draw the grid squares
                var y = 0;
                var x = 0;
                var index = 0;
                for (y = 0; y < rows; y++) {
                    for (x = 0; x < cols; x++) {
                        var grid_tag = "X" + pad(x.toString(), 2) + "Y" + pad(y.toString(), 2);
                        var grid_image = "";
                        var xoff = $("#sig_grid").position().left + 8.75 + (x * (45 + 8.75));
                        var yoff = $("#sig_grid").position().top + 8.75 + (y * (45 + 8.75));
                        var found = false;
                        for (index = 0; index < characters.length; index++) {
                            // If there is a character in this grid square...
                            if (characters[index].grid_tag === grid_tag) {
                                $(characters[index].myButton).css({
                                    top: yoff + 1,
                                    left: xoff + 1
                                });
                                var char_index = parseInt(characters[index].char_index);
                                // Render the various elements of the heros button (set the image to the correct costume, draw the level)
                                var image_name = "#" + pad(char_index.toString(), 2) + "_displayimage";
                                var costume = pad(characters[index].costume.toString(), 2);
                                var image_el = "#" + pad(char_index.toString(), 2) + "_" + costume + "_costume";
                                grid_image = $(image_el).attr("src");
                                $(image_name).attr("src", grid_image);
                                var level_label_name = "#" + pad(char_index.toString(), 2) + "_levellabel";
                                $(level_label_name).html(characters[index].level);
                                // This sets the button state correctly
                                prestigeChange(characters[index].char_index, characters[index].prestige);
                                renderFlair(characters[index].char_index);
                                if (characters[index].flair > 0) {
                                    for (var p = 0; p < flair.length; p++) {
                                        if (flair[p].flair_index === characters[index].flair) {
                                            $(characters[index].myFlairImage).attr("src", "glyphicons_free/glyphicons/png/" + flair[p].flair_file);
                                            $(characters[index].myFlairImage).show();
                                        }
                                    }
                                } else {
                                    $(characters[index].myFlairImage).hide();
                                }
                                if (characters[index].source > 0) {
                                    for (var p = 0; p < flair.length; p++) {
                                        if (flair[p].flair_index === characters[index].source) {
                                            $(characters[index].mySourceImage).attr("src", "glyphicons_free/glyphicons/png/" + flair[p].flair_file);
                                            $(characters[index].mySourceImage).show();
                                        }
                                    }
                                } else {
                                    $(characters[index].mySourceImage).hide();
                                }
                                if (characters[index].flair2 > 0) {
                                    for (var p = 0; p < flair.length; p++) {
                                        if (flair[p].flair_index === characters[index].flair2) {
                                            $(characters[index].myFlair2Image).attr("src", "glyphicons_free/glyphicons/png/" + flair[p].flair_file);
                                            $(characters[index].myFlair2Image).show();
                                        }
                                    }
                                } else {
                                    $(characters[index].myFlair2Image).hide();
                                }
                                // Show the level
                                if (characters[index].level > 0) {
                                    $(level_label_name).show();
                                } else {
                                    $(level_label_name).hide();
                                }
                                found = true;
                                break;
                            }
                        }
                        // Add the block to the grid
                        var id = grid_tag + "_gridblock";
                        var image_id = x.toString() + "_" + y.toString() + "_image";
                        var text = "<div class='GridButton' id='" + id + "' style='left:" + xoff.toString() + "px; top:" + yoff.toString() + "px;'><img id='" + image_id + "' class='CharacterImage'";
                        if (half_grids.indexOf(grid_tag) >= 0) {
                            text = text + " src='images_new/half.jpg'";
                        } else {
                            text = text + " src='images_new/blank.jpg'";
                        }
                        text = text + " /></div>";
                        $("#outerborder").append(text);
                        if (!found) {
                            $("#" + image_id).bind("mouseup touchstart", {gridx: x, gridy: y}, function (evt) {
                                toggleHalfWhole(evt);
                                evt.stopPropagation();
                            });
                        }

                    }
                    positionElements();
                }
            }

            function saveAndClose()
            {
                saveSig();
            }

            function closePopup()
            {
                $('#markdown_popup').fadeOut();
            }

            function closeLoad()
            {
                $('#load_popup').fadeOut();
            }

            function beginLoad()
            {
                $('#load_popup').fadeIn();
            }

            function escapeHtml(text) {
                var map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, function (m) {
                    return map[m];
                });
            }

            function buildCostumeMenus() {
                var xoff_costume = 8.75;
                var yoff_costume = 28.75;
                var i = 0;
                // Iterate over the characters
                for (i = 0; i < characters.length; i++)
                {
                    var curr_costume = "";
                    var costumes = "";
                    xoff_costume = 8.75;
                    yoff_costume = 28.75;
                    var char_index = characters[i].char_index;
                    var menu_name = pad(char_index, 2) + "_costumes";
                    // This builds the costume buttons and puts them inside the character div.
                    for (j = 0; j < characters[i].costume_indices.length; j++)
                    {
                        var cos_index = characters[i].costume_indices[j];
                        var button_name = pad(char_index, 2) + "_" + pad(cos_index, 2) + "_button";
                        var image_name = pad(char_index, 2) + "_" + pad(cos_index, 2) + "_costume";
                        var imagefile = characters[i].image_files[j];
                        var imagetitle = escapeHtml(characters[i].costume_names[j]);
                        costumes = costumes + "<div class='CostumeButton' title='" + imagetitle + "' id='" + button_name + "' style='left:" + xoff_costume + "px; top:" + yoff_costume + "px'><img id='" + image_name + "' class='CostumeImage' src='" + imagefile + "'/></div>";
                        xoff_costume += (45 + 8.75);
                        if (xoff_costume > 270) {
                            yoff_costume += (45 + 8.75);
                            xoff_costume = 8.75;
                        }
                    }
                    if (xoff_costume > 8.75) {
                        yoff_costume += (45 + 8.75);
                    }

                    view_mode = $('#view_mode').val();
                    // This creates the level control and the prestige buttons and puts them above the buttons (this is second because I added this feature after my initial attempt)
                    var level_name = pad(char_index, 2) + "_level";
                    var white_name = pad(char_index, 2) + "_white";
                    var green_name = pad(char_index, 2) + "_green";
                    var blue_name = pad(char_index, 2) + "_blue";
                    var purple_name = pad(char_index, 2) + "_purple";
                    var orange_name = pad(char_index, 2) + "_orange";
                    var red_name = pad(char_index, 2) + "_red";
                    var yellow_name = pad(char_index, 2) + "_yellow";
                    var flair_name = pad(char_index, 2) + "_flair";
                    var flair2_name = pad(char_index, 2) + "_flair2";
                    var source_name = pad(char_index, 2) + "_source";
                    curr_costume = "<div class='CostumeMenu' id='" + menu_name + "' style='width:435px; height:" + (yoff_costume + 26.75).toString() + "px'>";
                    var link_name = pad(char_index, 2) + "_link";
                    curr_costume = curr_costume + "<div class='LinkDiv' style='top:" + yoff_costume.toString() + "px'>Link:<input type='text' id='" + link_name + "' name='" + link_name + "' class='LinkArea' value=''></div>";
                    curr_costume = curr_costume + "<input type='text' id='" + level_name + "' name='" + level_name + "' class='LevelArea'>";
                    curr_costume = curr_costume + "<img src='images_new/ui_white_off.png' title='Prestige Level 0' id='" + white_name + "' name='" + white_name + "' class='whiteButton'/>";
                    curr_costume = curr_costume + "<img src='images_new/ui_green_off.png' title='Prestige Level 1' id='" + green_name + "' name='" + green_name + "' class='greenButton'/>";
                    curr_costume = curr_costume + "<img src='images_new/ui_blue_off.png' title='Prestige Level 2' id='" + blue_name + "' name='" + blue_name + "' class='blueButton'/>";
                    curr_costume = curr_costume + "<img src='images_new/ui_purple_off.png' title='Prestige Level 3' id='" + purple_name + "' name='" + purple_name + "' class='purpleButton'/>";
                    curr_costume = curr_costume + "<img src='images_new/ui_orange_off.png' title='Prestige Level 4' id='" + orange_name + "' name='" + orange_name + "' class='orangeButton'/>";
                    curr_costume = curr_costume + "<img src='images_new/ui_red_off.png' title='Prestige Level 5' id='" + red_name + "' name='" + red_name + "' class='redButton'/>";
                    curr_costume = curr_costume + "<img src='images_new/ui_yellow_off.png' title='Prestige Level 6' id='" + yellow_name + "' name='" + yellow_name + "' class='yellowButton'/>";
                    curr_costume = curr_costume + "<select name='" + flair_name + "' class='FlairArea' id='" + flair_name + "'>";
                    var k = 0;
                    for (k = 0; k < flair.length; k++) {
                        if (flair[k].flair_position === 0)
                        {
                            var theflair_name = flair[k].flair_name;
                            var theflair_index = flair[k].flair_index;
                            curr_costume = curr_costume + "<option value='" + theflair_index + "'>" + theflair_name + "</option>";
                        }
                    }
                    curr_costume = curr_costume + "</select>";
                    curr_costume = curr_costume + "<select name='" + source_name + "' class='SourceArea' id='" + source_name + "'>";
                    for (k = 0; k < flair.length; k++) {
                        if (flair[k].flair_position === 1)
                        {
                            var theflair_name = flair[k].flair_name;
                            var theflair_index = flair[k].flair_index;
                            curr_costume = curr_costume + "<option value='" + theflair_index + "'>" + theflair_name + "</option>";
                        }
                    }
                    curr_costume = curr_costume + "</select>";
                    curr_costume = curr_costume + "<select name='" + flair2_name + "' class='Flair2Area' id='" + flair2_name + "'>";
                    for (k = 0; k < flair.length; k++) {
                        if (flair[k].flair_position === 0 || flair[k].flair_position === 2)
                        {
                            var theflair_name = flair[k].flair_name;
                            var theflair_index = flair[k].flair_index;
                            curr_costume = curr_costume + "<option value='" + theflair_index + "'>" + theflair_name + "</option>";
                        }
                    }
                    curr_costume = curr_costume + "</select>";
                    curr_costume = curr_costume + costumes + "</div>";
                    $("#outerborder").append($(curr_costume));
                }
            }

            function convertLegacyCookies() {
                var num_characters = characters.length;
                // Grab the config
                var config_cookie = $.cookie("marvelsig_config");
                var new_level_grid = "";
                var i = 0;
                // Allocate some default grids
                for (i = 0; i < num_characters; i++) {
                    new_level_grid = new_level_grid + "000";
                }
                var new_position_grid = "";
                for (i = 0; i < num_characters; i++) {
                    new_position_grid = $new_position_grid + "X-1Y-1";
                }
                var new_costume_grid = "";
                for (i = 0; i < num_characters; i++) {
                    new_costume_grid = new_costume_grid + "00";
                }
                var x = 0;
                var y = 0;
                // Go through all of the characters and build the strings; I'm not going to belabor it, since this code also exists to a degree in the client.
                for (i = 0; i < num_characters; i++) {
                    char_index = characters[i].char_index;

                    if (config_cookie && config_cookie.length > 5 * char_index)
                    {
                        var level = config_cookie.substring(5 * char_index + 2, 3);
                        new_level_grid = setGridValue(new_level_grid, pad(level, 3), char_index, 3);
                    } else {
                        new_level_grid = new_level_grid + "000";
                    }
                    var grid_tag = "X-1Y-1";
                    if (config_cookie && config_cookie.length > (5 * char_index)) {
                        var cos = config_cookie.substring(5 * char_index, 2);
                        if (parseInt(cos) !== 99) {
                            new_costume_grid = setGridValue(new_costume_grid, pad(cos, 2), char_index, 2);
                            grid_tag = "X" + pad(x, 2, "0", STR_PAD_LEFT) + "Y" + pad(y, 2);
                            x += 1;
                            if (x > 13) {
                                y += 1;
                                x = 0;
                            }
                        } else {
                            new_costume_grid = setGridValue(new_costume_grid, "00", char_index, 2);
                        }
                    } else {
                        new_costume_grid = setGridValue(new_costume_grid, "00", char_index, 2);
                    }
                    new_position_grid = setGridValue(new_position_grid, grid_tag, char_index, 6);
                }
                if (x > 0) {
                    y += 1;
                }
                // Set the hidden fields with the new values
                $("#hidden_cols").val("14");
                $("#hidden_rows").val(strval($y + 1));
                $('#position_grid').val(new_position_grid);
                $('#costume_grid').val(new_costume_grid);
                $('#level_grid').val(new_level_grid);
            }

            var control_map = new Object();
            var costume_map = new Object();
            // This code attaches the various events to the different controls on the client side.
            function hookupControls() {
                var i = 0;
                for (i = 0; i < characters.length; i++)
                {
                    var char_index = characters[i].char_index.toString();
                    // Attach the hover commands to the character button
                    var button_name = pad(char_index, 2) + "_button";
                    control_map[button_name] = char_index;
                    $("#" + button_name).hover(function () {
                        showSelector(this);
                    }, function () {
                        hideSelector();
                    });
                    $("#" + button_name).draggable({stop: function (event, ui) {
                            dropCharacter(control_map[event.target.id], ui);
                        }});
                    $('#' + button_name).click(function (evt) {
                        showCharacterMenu(control_map[$(this).attr('id')]);
                        evt.stopPropagation();
                    });
                    var j = 0;
                    for (j = 0; j < characters[i].costume_indices.length; j++)
                    {
                        var cos_index = characters[i].costume_indices[j].toString();
                        button_name = pad(char_index, 2) + "_" + pad(cos_index, 2) + "_button";
                        control_map[button_name] = char_index;
                        costume_map[button_name] = cos_index;
                        $('#' + button_name).hover(function () {
                            showCostumeSelector(this);
                        }, function () {
                            hideSelector();
                        });
                        $('#' + button_name).bind('touchstart mouseup', function (evt) {
                            selectCostume(control_map[$(this).attr('id')], costume_map[$(this).attr('id')]);
                            evt.stopPropagation();
                        });
                    }
                    // Associate click events with the prestige buttons
                    var level_name = pad(char_index, 2) + "_level";
                    var white_name = pad(char_index, 2) + "_white";
                    var green_name = pad(char_index, 2) + "_green";
                    var blue_name = pad(char_index, 2) + "_blue";
                    var purple_name = pad(char_index, 2) + "_purple";
                    var orange_name = pad(char_index, 2) + "_orange";
                    var red_name = pad(char_index, 2) + "_red";
                    var yellow_name = pad(char_index, 2) + "_yellow";
                    var flair_name = pad(char_index, 2) + "_flair";
                    var flair2_name = pad(char_index, 2) + "_flair2";
                    var link_name = pad(char_index, 2) + "_link";
                    var source_name = pad(char_index, 2) + "_source";

                    control_map[level_name] = char_index;
                    control_map[white_name] = char_index;
                    control_map[green_name] = char_index;
                    control_map[blue_name] = char_index;
                    control_map[orange_name] = char_index;
                    control_map[purple_name] = char_index;
                    control_map[red_name] = char_index;
                    control_map[yellow_name] = char_index;
                    control_map[flair_name] = char_index;
                    control_map[flair2_name] = char_index;
                    control_map[link_name] = char_index;
                    control_map[source_name] = char_index;

                    $('#' + flair_name).bind('mouseup touchstart', function (evt) {
                        evt.stopPropagation();
                    });
                    $('#' + flair2_name).bind('mouseup touchstart', function (evt) {
                        evt.stopPropagation();
                    });
                    $('#' + source_name).bind('mouseup touchstart', function (evt) {
                        evt.stopPropagation();
                    });
                    $('#' + level_name).bind('mouseup touchstart', function (evt) {
                        evt.stopPropagation();
                    });
                    $('#' + link_name).bind('mouseup touchstart', function (evt) {
                        evt.stopPropagation();
                    });
                    $('#' + flair_name).change(function () {
                        flairChange(control_map[$(this).attr('id')]);
                    });
                    $('#' + flair2_name).change(function () {
                        flair2Change(control_map[$(this).attr('id')]);
                    });
                    $('#' + link_name).change(function () {
                        linkChange(control_map[$(this).attr('id')]);
                    });
                    $('#' + source_name).change(function () {
                        sourceChange(control_map[$(this).attr('id')]);
                    });
                    $('#' + level_name).change(function () {
                        levelChange(control_map[$(this).attr('id')]);
                    });
                    $('#' + white_name).click(function (evt) {
                        prestigeChange(control_map[$(this).attr('id')], 0);
                        evt.stopPropagation();
                    });
                    $('#' + green_name).click(function (evt) {
                        prestigeChange(control_map[$(this).attr('id')], 1);
                        evt.stopPropagation();
                    });
                    $('#' + blue_name).click(function (evt) {
                        prestigeChange(control_map[$(this).attr('id')], 2);
                        evt.stopPropagation();
                    });
                    $('#' + purple_name).click(function (evt) {
                        prestigeChange(control_map[$(this).attr('id')], 3);
                        evt.stopPropagation();
                    });
                    $('#' + orange_name).click(function (evt) {
                        prestigeChange(control_map[$(this).attr('id')], 4);
                        evt.stopPropagation();
                    });
                    $('#' + red_name).click(function (evt) {
                        prestigeChange(control_map[$(this).attr('id')], 5);
                        evt.stopPropagation();
                    });
                    $('#' + yellow_name).click(function (evt) {
                        prestigeChange(control_map[$(this).attr('id')], 6);
                        evt.stopPropagation();
                    });
                }
            }

            $(function () {
                init();
            });
        </script>
    </head>
    <body>
        <div id='helptext'>
            <table style='width:100%' class="TopRightTable">
                <tr>
                    <td><a href="help.html" target="_blank">Help</a></td>
                    <td><a href="configuresig_old.php" target="_blank">Old version</a></td>
                </tr>
            </table>
        </div>
        <div id='version'>
            <p>
                2.13.2
            </p>
        </div>
        <div id="outerborder">
            <img class='CharacterSelector' src='images_new/UI_Selector.png' alt='' id='c_selector'/>
            <div id='costumepen' style='height:0px'>
                <div class='titleclause'>
                    Drag characters from here
                </div>
            </div>
            <div id='sig_grid'>
                <div class='titleclause'>
                    Drop characters here
                </div>
            </div>
            <div id='preview'>

            </div>
            <div id='spinner' class='spinner'></div>
            <div id="markdown_popup" class="popup">
                <h2 class="dialogtitle">Your markdown</h2>
                <p>Copy your markdown from the box below and paste it into your signature settings on the Marvel Heroes forums.  Hit 'Close' when you are done.</p>
                <textarea id='markdown' name='markdown' rows='4' cols='60'></textarea><br>

                <center>
                    <table style="border:0px">
                        <tr>
                            <td>Keyword</td><td>
                                <input type='text' name='saved_keyword' id='saved_keyword'>
                            </td>
                            <td>Password</td><td>
                                <input type='password' name='saved_password' id='saved_password'>
                            </td>
                        </tr>
                        <tr><td colspan="2"><a href='javascript:saveAndClose()'>Save and Close</a></td><td colspan="2"><a href='javascript:closePopup()'>Just Close</a></td></tr></table></center>
            </div>
            <div id="load_popup" class="popup">
                <h2 class="dialogtitle">Load your sig</h2>
                <p>Enter your keyword and click "Load" to load your sig from the database.  Or, hit cancel to not do that.</p>
                <center><input type='text' id='load_keyword' name='load_keyword' class='InterfaceText'></center>
                <center><table style="border:0px"><tr><td><a href='javascript:loadSigFromDatabase()'>Load</a></td><td><a href='javascript:closeLoad()'>Cancel</a></td></tr></table></center>
            </div>
            <div id='footer'>
                <p>
                    All images are courtesy of <a href='https://forums.marvelheroes.com/discussion/42635/interactive-hero-roster-2-0'>@zztodd</a> on the Marvel Heroes forums.  Thanks, @zztodd!
                </p>
                <p>
                    Tooltip ideas and guidance courtesy of @docslax on the forums.  Fantastic bug-reporting provided by @Corodius.
                </p>
                <p>
                    Marvel Heroes content and materials are trademarks and copyrights of Gazillion Entertainment and its licensors.
                </p>
                <p>
                    Flair icons are courtesy of <a href='http://glyphicons.com/'>GLYPHICONS</a>, and are used under <a href='http://creativecommons.org/licenses/by/3.0/'>Creative Commons Attribution 3.0 Unported (CC BY 3.0)</a> license.
                </p>
                <p>
                    This tool is available under an <a href='http://opensource.org/licenses/MIT'>MIT License</a>.  Source code can be found in this <a href='https://github.com/seanwmcginnis/marvelheroessig'>Github repository</a>.
                </p>
            </div>        
            <div id='hiddens'>
                <input type='hidden' id='hidden_cols' name='hidden_cols'>
                <input type='hidden' id='hidden_rows' name='hidden_rows'>
                <input type='hidden' id='position_grid' name='position_grid'>
                <input type='hidden' id='level_grid' name='level_grid'>
                <input type='hidden' id='link_grid' name='link_grid'>
                <input type='hidden' id='costume_grid' name='costume_grid'>
                <input type='hidden' id='flair_grid' name='flair_grid'>
                <input type='hidden' id='half_grids' name='half_grids'>

            </div>            

            <div id = 'controls'>
                <div class = 'titleclause'>
                    Settings
                </div>
                <center>
                    <table class = 'DataTable'>
                        <tbody>
                            <tr>
                                <td>Font</td><td>
                                    <select name = 'font' id = 'font'>        
                                    </select></td>
                                <td>Shape</td><td>
                                    <select name='view_mode' id='view_mode'>
                                        <option value='0'>Sig should always be square</option>
                                        <option value='1'>Sig can be odd shaped</option>
                                    </select></td>
                            </tr>
                            <tr>
                                <td>Link</td><td>
                                    <select name='include_link' id='include_link'>
                                        <option value='1'>Include a link in markdown</option>
                                        <option value='0'>Omit the link</option>
                                    </select></td>

                                <td>Tooltips in markdown</td><td>
                                    <select name='include_tooltips' id='include_tooltips'>
                                        <option value='1'>Create tooltips with level</option>
                                        <option value='2'>Create tooltips without level</option>
                                        <option value='0'>Do not add tooltips</option>
                                    </select></td>
                            </tr>
                            <tr>
                                <td>Border Type</td><td>
                                    <select name='border_type' id='border_type'>
                                        <option value='0'>Black with Outer Border</option>
                                        <option value='1'>Just Black</option>
                                        <option value='2'>None.  No borders.</option>
                                        <option value='3'>Portrait Frame on Black</option>
                                        <option value='4'>Transparent Border</option>
                                        <option value='5'>Portrait Frame on Transparent</option>

                                    </select></td>

                                <td>Border color</td><td>
                                    <input name='border_color' id='border_color' class='color'>
                                </td>
                            </tr>                            
                            <tr>
                                <td colspan=4 style='text-align:center'>
                                    <table style='width:100%; border:0px;'>
                                        <tr>
                                            <td style='text-align:center'><a href='javascript:previewSig()'>Preview Sig</a></td>
                                            <td style='text-align:center'><a href='javascript:createSig()'>Create Sig</a></td>
                                            <td style='text-align:center'><a href='javascript:defaultLayout()'>Default Layout</a></td>
                                            <td style='text-align:center'><a href='javascript:clearLayout()'>Clear Layout</a></td>
                                            <td style='text-align:center'><a href='javascript:beginLoad()'>Load by Keyword</a></td>
                                        </tr>
                                    </table></td>
                        </tbody>
                    </table>
                </center>
            </div>               
        </div>
    </body>
</html>